# エンプラス kintone プラグイン

## 開発環境のセットアップ

Node.js、Yarn がインストールされていることが前提です。

リポジトリを clone し、プロジェクト内のディレクトリで以下のコマンドを実行します。

```shell
yarn
```

### プラグイン用秘密鍵ファイルの作成

プロジェクト内のディレクトリで以下のコマンドを実行します。

```
yarn prepare
```

- プラグインに同梱される秘密鍵ファイル `private.ppk` を作成します。
- このファイルはプラグインを一意に識別するためのファイルになります。
  - ファイルを破棄すると、kintone では別のプラグインとして扱われます。

### kintone 開発環境情報ファイルの作成

プロジェクトのルートディレクトリで以下を実行します。

```shell
cp .env.sample .env
```

- 作成された `.env` に開発用 kintone 環境のログイン情報を設定します。
- ここで設定した kintone 環境にプラグインをコマンドラインでアップロードできます（後述）。
- `.env` は git 管理されません。

## ビルドとプラグインのパッケージング

### TypeScript バージョンの指定（VSCode）

VSCode を利用している場合、下記の手順で TypeScript をワークスペースのバージョンに設定します。

- VSCode 任意の `.ts` または `.tsx` ファイル（ex. `./src/ts/yenplus/login.ts`）を開く
- ステータスバーに表示される TypeScript バージョン番号をクリック
- 「ワークスペースのバージョンを使用」をクリック

### プラグインのファイル名

パッケージングされたプラグインのファイル名は `src/manifest.json` の `name` `en` に設定された文字列を kebab case 化し、かつ `version` に設定されたバージョン番号を semver に似せた番号が付加されます。拡張子は必ず `.zip` になります。

下記の例では、出力されるプラグインのファイル名は `yenplus-kintone-plugin-0.0.1.zip` になります。

```json
{
  "manifest_version": 1,
  "name": {
    "en": "Yenplus kintone Plugin",
```

なお、バージョン番号 `1` が `0.0.1` として扱われる仕組みについては後述します。 

### 開発用ビルドの作成

プロジェクト内のディレクトリで以下のコマンドを実行します（以下同じ）

```shell
yarn build
```

- `./dist` にプラグイン Zip ファイルが出力されます。
- 開発用ビルドは `inline-source-map` を含みます。

### リリースビルドの作成

```shell
yarn release
```

- `./dist` にプラグイン Zip ファイルが出力されます。
- リリースビルドは uglify され、source map を含みません。

### ビルドしたプラグインのアップロード

```shell
yarn upload
```

`.env` に設定された環境にプラグインをアップロードします。

### 開発モード

下記のコマンドでプラグインを開発用ビルド（TypeScript コードのトランスパイルとバンドリング、プラグイン Zip ファイルを作成）し、上記で設定した環境に自動的にアップロードします。かつ、コード変更を監視を開始して、変更があるたびに再ビルドおよび再アップロードを実行します。

監視モードを抜けるには `ctrl+c` を押下します。

```shell
yarn start
```

### プラグインのバージョン番号について

kintone プラグインのバージョン番号は `src/manifest.json` に設定する仕様になっていますが、整数のみに限定されています。

```JSON
  "manifest_version": 1,
```

このため、このプラグインではバージョン番号を擬似的に semver に似せた表記に変換して表示しています。

- `1` → `0.0.1`
- `10` → `0.1.0`
- `100` → `1.0.0`

バージョンアップ時には上記を考慮して `manifest.json` のバージョン番号を更新してください。

### バージョンアップ通知

このプラグインでは、本番ビルドされたプラグインファイルを github リポジトリの Releases に登録することで、プラグイン設定画面でバージョンアップを通知し、最新バージョンをダウンロードできます。

- プラグインファイルを Releases に登録する際、バージョン番号は semver に準拠する必要があります。
- `src/releaseRepo.json` に github のリポジトリ情報を設定します。
